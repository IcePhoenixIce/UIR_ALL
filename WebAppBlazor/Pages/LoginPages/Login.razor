@layout CentredCardLayout
@page "/Login"
@using WebAppBlazor.Data;
@using WebAppBlazor.Data.Models;
@using WebAppBlazor.Services;
@using Newtonsoft.Json;
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject IPassesService passesService
 

			<EditForm Model="@user" OnValidSubmit="@ValidateUser">
				<DataAnnotationsValidator/>
				<ValidationSummary />
				<div>
					<br /><br />
				</div>
				<div>
					<h3 style="font-weight:bold; color:purple">Book Stores Login</h3>
				</div>
				<div>
					<br />
				</div>
				<div class="col-12 row"style="display:flex; flex-direction:row; flex-wrap:wrap; justify-content:center; align-items:center;">
					<input class="form-control col-8" @bind="user.UserLogin" placeholder="Login" style="width:300px"/>
				</div>
				<br />
				<div class="col-12 row" style="display:flex; flex-direction:row; flex-wrap:wrap; justify-content:center; align-items:center;">
					<input type="password" class="form-control col-8" @bind="user.PasswordHash" placeholder="Password" style="width:300px"/>
				</div>
				<br />
				<div class="col-12 row" style="display:flex; flex-direction:row; flex-wrap:wrap; justify-content:center; align-items:center;">
					<span class="col-8"></span>
					<input type="submit" class="form-control col-6 btn btn-primary" value="Login" style="width:300px"/>
					<div class="col-12 row" ></div>
					<a href="/SignUp" style="width:fit-content">Sign Up</a>
				</div>
				<br />
				<ValidationMess IsVisible="IsVisible" result="1" renderFragment="@LoginMessadge"/>
			</EditForm>

@code {

	private PassToken user;

	public string LoginMessadge { get; set; }

	public bool IsVisible { get; set; }

	protected override Task OnInitializedAsync()
	{
		IsVisible = false;
		user = new PassToken();
		return base.OnInitializedAsync();
	}

	private async Task<bool> ValidateUser()
	{
		PassToken pass2 = new PassToken(user);
		try
		{
			var returnedPass = await passesService.LoginAsync(pass2);

			if (returnedPass.Token != null)
			{
				((CustomAuthenticationStateProvider)AuthenticationStateProvider).MarkUserAsAuthenticated(returnedPass.UserUir.FirstName);

				NavigationManager.NavigateTo("/");

				await localStorage.SetItemAsync("user", JsonConvert.SerializeObject(returnedPass.UserUir));
				await localStorage.SetItemAsync("token", returnedPass.Token);
				return await Task.FromResult(true);
			}
			else
			{
				LoginMessadge = "Неправильный логин или пароль!";
				IsVisible = true;
				return await Task.FromResult(false);
			}
		}
		catch (Exception ex)
		{
			//Заглушка на обработку ошибок.
			LoginMessadge = "Не удалось подключится к серверу! Повторите попытку позже.";
			IsVisible = true;
			return await Task.FromResult(false);
		}

	}
}